name: CI_action

on:
  pull_request:
    branches:
      - main

jobs:
  ci_job:
    runs-on: ubuntu-latest

    env:
      DBT_ENV_SECRET_TYPE: ${{ secrets.DBT_ENV_SECRET_TYPE }}
      DBT_ENV_SECRET_PROJECT_ID: ${{ secrets.DBT_ENV_SECRET_PROJECT_ID }}
      DBT_ENV_SECRET_PRIVATE_KEY_ID: ${{ secrets.DBT_ENV_SECRET_PRIVATE_KEY_ID }}
      DBT_ENV_SECRET_PRIVATE_KEY: ${{ secrets.DBT_ENV_SECRET_PRIVATE_KEY }}
      DBT_ENV_SECRET_CLIENT_EMAIL: ${{ secrets.DBT_ENV_SECRET_CLIENT_EMAIL }}
      DBT_ENV_SECRET_CLIENT_ID: ${{ secrets.DBT_ENV_SECRET_CLIENT_ID }}
      DBT_ENV_SECRET_AUTH_URI: ${{ secrets.DBT_ENV_SECRET_AUTH_URI }}
      DBT_ENV_SECRET_TOKEN_URI: ${{ secrets.DBT_ENV_SECRET_TOKEN_URI }}
      DBT_ENV_SECRET_AUTH_PROVIDER_X509_CERT_URL: ${{ secrets.DBT_ENV_SECRET_AUTH_PROVIDER_X509_CERT_URL }}
      DBT_ENV_SECRET_CLIENT_X509_CERT_URL: ${{ secrets.DBT_ENV_SECRET_CLIENT_X509_CERT_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r dbt-requirements.txt

      - name: Download latest manifest.json artifact from main
        id: download_manifest
        shell: bash
        run: |
          echo "🔍 Fetching manifest artifact from main..."
          curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/artifacts" \
              -o artifacts.json

          artifact_id=$(grep -A10 '"name": "dbt-manifest"' artifacts.json \
            | grep '"archive_download_url":' \
            | head -n1 \
            | sed 's/.*artifacts\/\([0-9]*\)\/zip.*/\1/' || true)

          if [ -z "$artifact_id" ]; then
            echo "⚠️ Manifest artifact not found. Will run FULL build."
            echo "found_manifest=false" >> $GITHUB_OUTPUT
          else
            echo "✅ Found artifact ID: $artifact_id"
            curl -sL -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$artifact_id/zip" \
                -o artifact.zip
            unzip -q artifact.zip -d prod_state
            echo "✅ manifest.json extracted to ./prod_state/"
            echo "found_manifest=true" >> $GITHUB_OUTPUT
          fi

      - name: Run dbt debug
        run: dbt debug --target dev

      - name: Run dbt deps
        run: dbt deps --target dev

      - name: Run dbt seed
        run: dbt seed --target dev

      - name: Run dbt models and tests
        run: |
          if [ "${{ steps.download_manifest.outputs.found_manifest }}" = "true" ]; then
            echo "🚀 Running SLIM CI with state:modified+"
            dbt run -s 'state:modified+' --defer --state ./prod_state --target dev
            dbt test -s 'state:modified+' --defer --state ./prod_state --target dev
          else
            echo "🚀 Running FULL dbt build (no manifest found)"
            dbt run --target dev
            dbt test --target dev
          fi

      - name: Drop PR schema
        run: |
          dbt run-operation drop_pr_staging_schemas \
            --args '{"project_id": "${{ secrets.DBT_ENV_SECRET_PROJECT_ID }}", "PR_number": "${{ github.event.pull_request.number }}"}' \
            --profiles-dir ./
